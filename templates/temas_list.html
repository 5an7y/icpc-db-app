{% extends "base.html" %}

{% block title %}Temas · ICPC DB{% endblock %}

{% block content %}
<style>
  #tabla-temas tbody tr {
    cursor: move;
  }
  #tabla-temas tbody tr.dragging {
    opacity: 0.6;
  }
</style>
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">Temas</h1>
    <div class="d-flex align-items-center">
        <button id="btn-guardar-orden"
                type="button"
                class="btn btn-sm btn-outline-primary me-2"
                disabled>
        Guardar orden
        </button>
        <a href="{{ url_for('nuevo_tema') }}" class="btn btn-sm btn-success">
        + Nuevo tema
        </a>
    </div>
    </div>

    <p class="text-muted">
    Puedes arrastrar las filas para cambiar el orden.  
    Cuando termines, usa <strong>Guardar orden</strong>.
    </p>

    <form id="form-orden" method="POST" action="{{ url_for('guardar_orden_temas_route') }}">
    <input type="hidden" name="orden" id="input-orden">
    </form>


  {% if temas %}
    <div class="table-responsive">
      <table id="tabla-temas" class="table table-striped table-hover align-middle">
        <thead class="table-dark">
          <tr>
            <th style="width: 4rem;">Orden</th>
            <th>Nombre</th>
            <th>Categoría</th>
            <th>Ruta explicación</th>
            <th style="width: 14rem;">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for tema in temas %}
            {% set anchor = 'tema-' ~ tema.nombre|replace(' ', '-') %}
    <tr id="{{ anchor }}"
        draggable="true"
        data-nombre="{{ tema.nombre }}">
      <td>{{ tema.orden }}</td>
      <td>{{ tema.nombre }}</td>
      <td>{{ tema.categoria }}</td>
      <td>
        {% if tema.ruta %}
          <a href="{{ url_for('ver_tema', nombre=tema.nombre) }}"
             class="btn btn-sm btn-outline-info">
            Ver explicación
          </a>
        {% else %}
          <span class="text-muted">Sin ruta</span>
        {% endif %}
      </td>
      <td class="text-nowrap">
        <a href="{{ url_for('editar_tema', nombre=tema.nombre) }}" 
           class="btn btn-sm btn-primary ms-1">
          Editar
        </a>

        <form action="{{ url_for('eliminar_tema', nombre=tema.nombre) }}"
              method="POST" style="display:inline-block;"
              onsubmit="return confirm('¿Seguro que deseas eliminar este tema?');">
          <button class="btn btn-sm btn-danger ms-1">Eliminar</button>
        </form>
      </td>
    </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p class="text-muted">Aún no tienes temas registrados.</p>
  {% endif %}

  <script>
document.addEventListener('DOMContentLoaded', function () {
  const tbody = document.querySelector('#tabla-temas tbody');
  const btnGuardar = document.getElementById('btn-guardar-orden');
  const inputOrden = document.getElementById('input-orden');
  const formOrden = document.getElementById('form-orden');

  if (!tbody || !btnGuardar || !inputOrden || !formOrden) {
    return;
  }

  let draggingRow = null;

  tbody.addEventListener('dragstart', function (e) {
    const row = e.target.closest('tr[draggable="true"]');
    if (!row) return;
    draggingRow = row;
    row.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
  });

  tbody.addEventListener('dragend', function () {
    if (draggingRow) {
      draggingRow.classList.remove('dragging');
      draggingRow = null;
    }
  });

  tbody.addEventListener('dragover', function (e) {
    e.preventDefault(); // necesario para permitir drop
    const row = e.target.closest('tr[draggable="true"]');
    if (!row || row === draggingRow) return;

    const bounding = row.getBoundingClientRect();
    const offset = e.clientY - bounding.top;
    const midpoint = bounding.height / 2;

    if (offset < midpoint) {
      tbody.insertBefore(draggingRow, row);
    } else {
      tbody.insertBefore(draggingRow, row.nextSibling);
    }

    // Habilitar el botón de guardar porque hubo cambios
    btnGuardar.disabled = false;
  });

  btnGuardar.addEventListener('click', function () {
    const rows = tbody.querySelectorAll('tr[draggable="true"][data-nombre]');
    const nombres = Array.from(rows).map(r => r.dataset.nombre);
    inputOrden.value = nombres.join(',');
    formOrden.submit();
  });
});
</script>

{% endblock %}

